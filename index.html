<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Casa da Música</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; }
        
        .no-print { 
            background: white; padding: 20px; border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 1100px; margin: 0 auto 20px; 
        }

        .controles-mes { display: flex; gap: 10px; margin-bottom: 15px; }
        select, button { padding: 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 14px; }
        
        .btn-imprimir { background-color: #28a745; color: white; border: none; font-weight: bold; cursor: pointer; flex-grow: 1; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; }
        th, td { border: 1px solid #000; height: 35px; font-size: 11px; text-align: center; }
        
        .col-nome { width: 300px; text-align: left !important; padding-left: 8px; font-weight: bold; }
        .col-dia-aula { width: 45px; } /* Colunas maiores para os dias de aula */
        
        .col-admin { width: 60px; background-color: #f8f9fa; font-weight: bold; }

        @media print {
            @page { size: A4 landscape; margin: 8mm; }
            .no-print, .col-admin { display: none !important; }
            body { background: white; padding: 0; }
            td { height: 40px; font-size: 12px; }
            th { background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <h2 style="margin-top:0">Gerador de Chamada Cronológica</h2>
        <div class="controles-mes">
            <select id="select-mes">
                <option value="0">Janeiro</option><option value="1">Fevereiro</option>
                <option value="2">Março</option><option value="3">Abril</option>
                <option value="4">Maio</option><option value="5">Junho</option>
                <option value="6">Julho</option><option value="7">Agosto</option>
                <option value="8">Setembro</option><option value="9">Outubro</option>
                <option value="10">Novembro</option><option value="11">Dezembro</option>
            </select>
            <select id="select-turmas"><option value="">Carregando turmas...</option></select>
            <button class="btn-imprimir" onclick="window.print()">IMPRIMIR FOLHA DO MÊS</button>
        </div>
    </div>

    <div class="area-chamada">
        <div id="cabecalho-print" style="border: 2px solid #000; padding: 10px; margin-bottom: 10px;">
            <h2 id="titulo-mes" style="text-align:center; margin: 0; font-size: 18px; text-transform: uppercase;">FOLHA DE FREQUÊNCIA</h2>
            <div id="info-turma" style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 10px; text-transform: uppercase;"></div>
        </div>

        <table>
            <thead>
                <tr id="linha-dias">
                    <th class="col-nome">NOME DO ALUNO</th>
                    <th class="col-admin">PRES.</th>
                    <th class="col-admin">FALT.</th>
                </tr>
            </thead>
            <tbody id="corpo-tabela"></tbody>
        </table>
    </div>

    <script>
        // Use suas chaves aqui
        const URL = 'SUA_URL_AQUI'; 
        const KEY = 'SUA_KEY_AQUI';
        const supabase = supabase.createClient(URL, KEY);

        const selTurma = document.getElementById('select-turmas');
        const selMes = document.getElementById('select-mes');
        const corpo = document.getElementById('corpo-tabela');
        const linhaDias = document.getElementById('linha-dias');

        selMes.value = new Date().getMonth();

        async function carregarTurmas() {
            const { data } = await supabase.from('turmas').select('*').order('professor');
            selTurma.innerHTML = '<option value="">Selecione a Turma...</option>';
            data.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.dataset.dias = t.dias;
                opt.innerText = `${t.professor} - ${t.oficina} (${t.horario})`;
                selTurma.appendChild(opt);
            });
        }

        function obterDiasDeAulaNoMes() {
            const mes = parseInt(selMes.value);
            const ano = new Date().getFullYear();
            const ultimoDia = new Date(ano, mes + 1, 0).getDate();
            const turmaSelecionada = selTurma.options[selTurma.selectedIndex];
            
            // Converte {1,3} para [1,3]
            const diasAulaPermitidos = turmaSelecionada.dataset.dias ? 
                JSON.parse(turmaSelecionada.dataset.dias.replace('{','[').replace('}',']')) : [];

            const datasEncontradas = [];
            for (let i = 1; i <= ultimoDia; i++) {
                const dataRef = new Date(ano, mes, i);
                if (diasAulaPermitidos.includes(dataRef.getDay())) {
                    datasEncontradas.push({
                        dia: i.toString().padStart(2, '0'),
                        labelSemana: ['DOM','SEG','TER','QUA','QUI','SEX','SAB'][dataRef.getDay()]
                    });
                }
            }
            return datasEncontradas;
        }

        async function atualizarTabela() {
            const tId = selTurma.value;
            if (!tId) return;

            const diasDeAula = obterDiasDeAulaNoMes();
            const { data: turma } = await supabase.from('turmas').select('*').eq('id', tId).single();
            const ano = new Date().getFullYear();

            // Atualiza Título e Cabeçalho
            document.getElementById('titulo-mes').innerText = `FOLHA DE FREQUÊNCIA - ${selMes.options[selMes.selectedIndex].text} / ${ano}`;
            document.getElementById('info-turma').innerHTML = `<span><strong>Prof:</strong> ${turma.professor}</span><span><strong>Oficina:</strong> ${turma.oficina}</span><span><strong>Horário:</strong> ${turma.horario}</span>`;

            // Limpa e gera novas colunas de dias
            document.querySelectorAll('.col-gerada').forEach(el => el.remove());
            const thAdmin = document.querySelectorAll('.col-admin');
            diasDeAula.forEach(d => {
                const th = document.createElement('th');
                th.className = 'col-gerada col-dia-aula';
                th.innerHTML = `${d.dia}<br><small>${d.labelSemana}</small>`;
                linhaDias.insertBefore(th, thAdmin[0]);
            });

            // Busca Alunos
            const { data: alunos } = await supabase.from('alunos').select('id, nome_completo, frequencia(status)').eq('turma_id', tId).order('nome_completo');

            corpo.innerHTML = '';
            alunos.forEach(aluno => {
                const p = aluno.frequencia?.filter(f => f.status === 'P').length || 0;
                const f = aluno.frequencia?.filter(f => f.status === 'F').length || 0;

                const tr = document.createElement('tr');
                let html = `<td class="col-nome">${aluno.nome_completo}</td>`;
                
                // Cria apenas os quadradinhos dos dias de aula
                diasDeAula.forEach(() => {
                    html += `<td></td>`;
                });
                
                html += `<td class="col-admin">${p}</td><td class="col-admin">${f}</td>`;
                tr.innerHTML = html;
                corpo.appendChild(tr);
            });

            // Linhas vazias para preencher a folha
            for (let i = (alunos ? alunos.length : 0); i < 18; i++) {
                const tr = document.createElement('tr');
                let html = `<td class="col-nome"></td>` + `<td></td>`.repeat(diasDeAula.length) + `<td class="col-admin"></td><td class="col-admin"></td>`;
                tr.innerHTML = html;
                corpo.appendChild(tr);
            }
        }

        selTurma.addEventListener('change', atualizarTabela);
        selMes.addEventListener('change', atualizarTabela);
        carregarTurmas();
    </script>
</body>
</html>
