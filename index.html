<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Casa da Música - Sistema de Frequência</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ESTILO VOLTADO PARA O DESIGN DA FOTO */
        body { font-family: 'Arial Black', Gadget, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        
        .no-print { 
            background: #fff; padding: 20px; border: 2px solid #000;
            max-width: 900px; margin: 0 auto 20px; display: flex; gap: 10px;
        }

        .area-chamada { 
            background: white; width: 297mm; min-height: 210mm; margin: 0 auto; 
            padding: 15mm; box-sizing: border-box; border: 1px solid #ccc;
            position: relative;
        }

        /* CABEÇALHO IDÊNTICO À IMAGEM */
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .piano-logo { width: 60px; height: 60px; border: 4px solid #000; display: flex; align-items: flex-end; justify-content: space-around; padding: 5px; }
        .piano-key { width: 10px; height: 35px; background: #000; }
        
        .titulo-prof h1 { margin: 0; font-size: 35px; text-transform: uppercase; line-height: 1; }
        .titulo-prof h2 { margin: 0; font-size: 18px; text-decoration: underline; font-style: italic; }

        .caixa-mes { background: #000; color: #fff; padding: 10px 30px; text-align: center; }
        .caixa-mes h2 { margin: 0; font-size: 28px; }
        .caixa-mes p { margin: 0; font-size: 12px; }

        /* BARRA DE INFORMAÇÕES COM BORDAS FORTES */
        .info-tab { display: grid; grid-template-columns: 1fr 1fr 1fr; border: 4px solid #000; margin-bottom: 15px; }
        .info-box { border-right: 3px solid #000; padding: 10px; }
        .info-box:last-child { border-right: none; }
        .label { display: block; font-size: 10px; font-weight: bold; }
        .value { display: block; font-size: 16px; font-weight: bold; text-transform: uppercase; }

        /* TABELA DE CHAMADA */
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 2px solid #000; height: 35px; text-align: center; font-size: 12px; }
        .name-cell { text-align: left; padding-left: 10px; width: 350px; text-transform: uppercase; }

        /* RODAPÉ PERSONALIZADO */
        .footer-notas { margin-top: 15px; border-top: 2px solid #000; padding-top: 10px; display: flex; justify-content: space-between; font-size: 12px; }
        .icone-discreto { opacity: 0.1; filter: grayscale(1); position: absolute; right: 20px; bottom: 20px; width: 80px; }

        @media print {
            @page { size: A4 landscape; margin: 0; }
            .no-print { display: none; }
            .area-chamada { border: none; padding: 10mm; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <select id="mes-select">
            <option value="0">JANEIRO</option><option value="1">FEVEREIRO</option>
            <option value="2">MARÇO</option><option value="3">ABRIL</option>
            <option value="4">MAIO</option><option value="5">JUNHO</option>
            <option value="6">JULHO</option><option value="7">AGOSTO</option>
            <option value="8">SETEMBRO</option><option value="9">OUTUBRO</option>
            <option value="10">NOVEMBRO</option><option value="11">DEZEMBRO</option>
        </select>
        <select id="turma-select"><option>Carregando...</option></select>
        <button onclick="window.print()" style="cursor:pointer; background:#000; color:#fff; font-weight:bold;">IMPRIMIR</button>
    </div>

    <div class="area-chamada">
        <div class="header-top">
            <div class="logo-area">
                <div class="piano-logo"><div class="piano-key"></div><div class="piano-key"></div><div class="piano-key"></div></div>
                <div class="titulo-prof">
                    <h1 id="out-prof">---</h1>
                    <h2 id="out-oficina-sub">OFICINA: ---</h2>
                </div>
            </div>
            <div class="caixa-mes">
                <h2 id="out-mes">MÊS</h2>
                <p>CASA DA MÚSICA 2026</p>
            </div>
        </div>

        <div class="info-tab">
            <div class="info-box"><span class="label">Oficina:</span><span id="out-oficina" class="value">---</span></div>
            <div class="info-box"><span class="label">Classificação:</span><span class="value">Básico</span></div>
            <div class="info-box"><span class="label">Horário:</span><span id="out-horario" class="value">---</span></div>
        </div>

        <table id="tabela-chamada">
            <thead>
                <tr id="row-datas">
                    <th style="width:30px">Nº</th>
                    <th class="name-cell">NOME DO ALUNO</th>
                    <th style="width:40px">P</th>
                    <th style="width:40px">F</th>
                </tr>
            </thead>
            <tbody id="lista-alunos"></tbody>
        </table>

        <div class="footer-notas">
            <div id="frase-inspiradora">"A música é a linguagem universal."</div>
            <div>ASSINATURA DO PROFESSOR: _________________________________</div>
        </div>
        <img id="img-icone" class="icone-discreto" src="">
    </div>

    <script>
        // CHAVES CORRIGIDAS E INTEGRADAS
        const _URL = "https://ovswayndqjujyidshwzv.supabase.co";
        const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c3dheW5kcWp1anlpZHNod3p2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgxODA4NDIsImV4cCI6MjA1Mzc1Njg0Mn0.yYmF0Xy_D799X0680_WnS8Bhq8B0V5yLqL-E-yL6_K4";
        const supabaseClient = supabase.createClient(_URL, _KEY);

        const selTurma = document.getElementById('turma-select');
        const selMes = document.getElementById('mes-select');

        // Banco de Frases e Ícones
        const frases = {
            'CARLOS': "O piano é o coração da harmonia.",
            'MICHEL': "Ritmo e precisão transformam o som.",
            'ESTHER': "A voz é o espelho da alma."
        };

        const icones = {
            'PIANO': 'https://img.icons8.com/ios-filled/100/piano.png',
            'VIOLÃO': 'https://img.icons8.com/ios-filled/100/acoustic-guitar.png',
            'VOCAL': 'https://img.icons8.com/ios-filled/100/microphone.png'
        };

        async function carregarTurmas() {
            const { data } = await supabaseClient.from('turmas').select('*').order('professor');
            selTurma.innerHTML = '<option value="">Selecione a Turma</option>';
            data.forEach(t => {
                let opt = document.createElement('option');
                opt.value = t.id;
                opt.dataset.dias = t.dias;
                opt.innerText = `${t.professor} - ${t.oficina}`;
                selTurma.appendChild(opt);
            });
        }

        async function atualizar() {
            const id = selTurma.value;
            if(!id) return;

            const mes = parseInt(selMes.value);
            const { data: turma } = await supabaseClient.from('turmas').select('*').eq('id', id).single();
            const { data: alunos } = await supabaseClient.from('alunos').select('*').eq('turma_id', id).order('nome_completo');

            // Preencher campos
            document.getElementById('out-prof').innerText = turma.professor;
            document.getElementById('out-oficina-sub').innerText = `OFICINA: ${turma.oficina}`;
            document.getElementById('out-oficina').innerText = turma.oficina;
            document.getElementById('out-horario').innerText = `${turma.horario} (${turma.dias == '{1,3}' ? '2ª/4ª' : '3ª/5ª'})`;
            document.getElementById('out-mes').innerText = selMes.options[mes].text;
            document.getElementById('frase-inspiradora').innerText = frases[turma.professor.toUpperCase()] || "A música transforma vidas.";
            document.getElementById('img-icone').src = icones[turma.oficina.toUpperCase()] || '';

            // Gerar Datas
            const diasAula = JSON.parse(turma.dias.replace('{','[').replace('}',']'));
            const rowDatas = document.getElementById('row-datas');
            document.querySelectorAll('.dt-col').forEach(e => e.remove());

            let datasEncontradas = [];
            let ultimoDia = new Date(2026, mes + 1, 0).getDate();
            for(let i=1; i<=ultimoDia; i++){
                let d = new Date(2026, mes, i);
                if(diasAula.includes(d.getDay())){
                    let format = `${i.toString().padStart(2,'0')}/${(mes+1).toString().padStart(2,'0')}`;
                    datasEncontradas.push(format);
                    let th = document.createElement('th'); th.className = 'dt-col'; th.innerText = format;
                    rowDatas.insertBefore(th, rowDatas.cells[rowDatas.cells.length - 2]);
                }
            }

            // Lista Alunos
            const corpo = document.getElementById('lista-alunos');
            corpo.innerHTML = '';
            for(let i=0; i < Math.max(15, alunos.length); i++){
                let tr = document.createElement('tr');
                let html = `<td>${i+1}</td><td class="name-cell">${alunos[i]?.nome_completo || ''}</td>`;
                datasEncontradas.forEach(() => html += '<td></td>');
                html += '<td></td><td></td>';
                tr.innerHTML = html;
                corpo.appendChild(tr);
            }
        }

        selTurma.onchange = atualizar;
        selMes.onchange = atualizar;
        carregarTurmas();
    </script>
</body>
</html>
