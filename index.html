<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Casa da Música - Chamada Automática</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* ESTILOS PARA TELA (O que você vê no navegador) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; }
        
        .no-print {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        h3 { margin-top: 0; color: #333; }
        
        select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
        }

        .btn-imprimir {
            background-color: #28a745;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }

        .btn-imprimir:hover { background-color: #218838; }

        /* ESTILOS PARA A FOLHA (O que sai na impressora) */
        .print-area {
            background: white;
            padding: 10px;
            display: none; /* Escondido na tela, aparece na impressão */
        }

        .header-chamada {
            border: 2px solid #000;
            padding: 10px;
            margin-bottom: 10px;
        }

        .info-linha {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            text-transform: uppercase;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* Garante que as colunas não dancem */
        }

        th, td {
            border: 1px solid #000;
            height: 30px;
            font-size: 9px;
            text-align: center;
        }

        .col-nome {
            width: 25%; /* Nome ocupa 1/4 da folha */
            text-align: left !important;
            padding-left: 5px;
            font-weight: bold;
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
        }

        .col-dia {
            width: 2.4%; /* Divide o restante para os 31 dias */
            background-color: #f0f0f0;
        }

        /* CONFIGURAÇÃO DE IMPRESSÃO */
        @media print {
            @page { 
                size: A4 landscape; /* Folha deitada */
                margin: 5mm; 
            }
            .no-print { display: none; }
            .print-area { display: block; }
            body { background: white; padding: 0; }
            
            /* Aumenta a altura para facilitar o X da caneta */
            td { height: 35px; } 
            th { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <h3>Gerador de Folha de Chamada</h3>
        <p>Selecione a turma abaixo e clique em imprimir:</p>
        <select id="lista-turmas">
            <option value="">Carregando turmas...</option>
        </select>
        <button class="btn-imprimir" onclick="window.print()">IMPRIMIR FOLHA DE FREQUÊNCIA</button>
    </div>

    <div id="folha-frequencia" class="print-area">
        <div class="header-chamada">
            <h2 style="text-align:center; margin: 0; font-size: 18px;">CASA DA MÚSICA - FOLHA DE FREQUÊNCIA</h2>
            <div id="detalhes-turma" class="info-linha">
                </div>
        </div>

        <table>
            <thead>
                <tr id="cabecalho-dias">
                    <th class="col-nome">NOME DO ALUNO</th>
                    </tr>
            </thead>
            <tbody id="corpo-alunos">
                </tbody>
        </table>
    </div>

    <script>
        // 1. DADOS DE CONEXÃO (Não mexer na estrutura, apenas preencher suas chaves)
        const URL = 'SUA_URL_DO_SUPABASE'; 
        const KEY = 'SUA_ANON_KEY_DO_SUPABASE';
        const supabaseClient = supabase.createClient(URL, KEY);

        const select = document.getElementById('lista-turmas');
        const corpoAlunos = document.getElementById('corpo-alunos');
        const detalhesTurma = document.getElementById('detalhes-turma');

        // 2. Criar as colunas de 01 a 31 no cabeçalho
        const cabecalhoDias = document.getElementById('cabecalho-dias');
        for (let i = 1; i <= 31; i++) {
            const th = document.createElement('th');
            th.className = 'col-dia';
            th.innerText = i.toString().padStart(2, '0');
            cabecalhoDias.appendChild(th);
        }

        // 3. Buscar turmas e colocar no Select
        async function carregarTurmas() {
            const { data, error } = await supabaseClient
                .from('turmas')
                .select('*')
                .order('professor', { ascending: true });

            if (data) {
                select.innerHTML = '<option value="">Escolha a Turma...</option>';
                data.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.text = `${t.professor} - ${t.oficina} (${t.horario})`;
                    select.appendChild(opt);
                });
            }
        }

        // 4. Quando selecionar uma turma, carregar os alunos
        select.addEventListener('change', async (e) => {
            const turmaId = e.target.value;
            if (!turmaId) return;

            // Busca detalhes da turma selecionada
            const { data: turma } = await supabaseClient
                .from('turmas')
                .select('*')
                .eq('id', turmaId)
                .single();

            // Atualiza o cabeçalho da impressão
            detalhesTurma.innerHTML = `
                <span><strong>Professor:</strong> ${turma.professor}</span>
                <span><strong>Oficina:</strong> ${turma.oficina}</span>
                <span><strong>Horário:</strong> ${turma.horario}</span>
                <span><strong>Dias:</strong> ${turma.dias}</span>
            `;

            // Busca os alunos matriculados (Filtrando por turma_id)
            const { data: alunos } = await supabaseClient
                .from('alunos')
                .select('nome_completo')
                .eq('turma_id', turmaId)
                .order('nome_completo', { ascending: true });

            corpoAlunos.innerHTML = '';

            // Adiciona as linhas dos alunos
            if (alunos && alunos.length > 0) {
                alunos.forEach(aluno => {
                    const tr = document.createElement('tr');
                    let html = `<td class="col-nome">${aluno.nome_completo}</td>`;
                    for (let i = 0; i < 31; i++) html += '<td></td>';
                    tr.innerHTML = html;
                    corpoAlunos.appendChild(tr);
                });
            }

            // Completa a folha com linhas em branco (mínimo 18 linhas no total)
            const totalLinhas = Math.max(18, (alunos ? alunos.length : 0));
            for (let i = (alunos ? alunos.length : 0); i < totalLinhas; i++) {
                const tr = document.createElement('tr');
                let html = `<td class="col-nome"></td>`;
                for (let j = 0; j < 31; j++) html += '<td></td>';
                tr.innerHTML = html;
                corpoAlunos.appendChild(tr);
            }
        });

        // Iniciar o sistema
        carregarTurmas();
    </script>
</body>
</html>
