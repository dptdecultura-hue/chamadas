<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>CASA DA M√öSICA 2026 - SUPREMA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; padding: 0 !important; }
            .folha-chamada { border: none !important; width: 100% !important; margin: 0 !important; padding: 0.5cm !important; box-shadow: none !important; }
            table, th, td { border: 2.5pt solid black !important; }
            .header-box { border: 4pt solid black !important; }
        }
        .folha-chamada { width: 29.7cm; min-height: 20cm; padding: 1.2cm; background: white; margin: 20px auto; border: 4px solid #000; position: relative; }
        .tabela-chamada { width: 100%; border-collapse: collapse; }
        .tabela-chamada th, .tabela-chamada td { border: 2pt solid black; padding: 6px; text-align: center; font-size: 13px; font-weight: 900; height: 40px; }
        .header-box { border: 4pt solid black; display: flex; margin-bottom: 15px; background: white; }
        .header-item { border-right: 2.5pt solid black; padding: 10px 15px; flex-grow: 1; }
        .header-item:last-child { border-right: none; }
        .card-selecao { border: 4px solid black; transition: 0.2s; cursor: pointer; background: white; }
        .card-selecao:hover { background: #fbbf24; transform: translateY(-2px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPA_URL = "https://wilmewhekkvcocjbydxb.supabase.co";
        const SUPA_KEY = "sb_publishable_mHXaPK-MFZYUggo-qy2soQ_yDDBr1IH";
        const supabaseClient = supabase.createClient(SUPA_URL, SUPA_KEY);

        const App = () => {
            const [aba, setAba] = useState('menu');
            const [professorAtivo, setProfessorAtivo] = useState("");
            const [turmas, setTurmas] = useState([]);
            const [idTurma, setIdTurma] = useState(null);
            const [alunos, setAlunos] = useState([]);
            const [mes, setMes] = useState(new Date().getMonth());
            const [carregando, setCarregando] = useState(false);

            useEffect(() => {
                const fetchTurmas = async () => {
                    const { data } = await supabaseClient.from('turmas').select('*').order('professor');
                    if (data) setTurmas(data);
                };
                fetchTurmas();
            }, []);

            // Fun√ß√£o disparada ao clicar na turma
            const selecionarTurma = async (id) => {
                setCarregando(true);
                setIdTurma(id);
                setAba('chamada');
                
                try {
                    const { data, error } = await supabaseClient
                        .from('alunos')
                        .select('nome_completo')
                        .eq('turma_id', id)
                        .order('nome_completo');

                    if (data) {
                        const preenchidos = Array(20).fill("").map((_, i) => ({ 
                            nome: data[i] ? data[i].nome_completo : "" 
                        }));
                        setAlunos(preenchidos);
                    }
                } catch (e) {
                    console.error("Erro ao carregar alunos", e);
                } finally {
                    setCarregando(false);
                }
            };

            const turmaAtiva = turmas.find(t => t.id === idTurma);
            const professores = [...new Set(turmas.map(t => t.professor))];

            const gerarDatas = () => {
                if (!turmaAtiva || !turmaAtiva.dias) return [];
                const dts = [];
                // Converte string do banco {1,3} ou texto para array de n√∫meros
                const diasLimpos = turmaAtiva.dias.toString().replace(/{|}|\[|\]/g, '').split(',').map(Number);
                const ultimoDia = new Date(2026, mes + 1, 0).getDate();
                
                for (let i = 1; i <= ultimoDia; i++) {
                    const d = new Date(2026, mes, i);
                    if (diasLimpos.includes(d.getDay())) {
                        dts.push(`${i.toString().padStart(2,'0')}/${(mes+1).toString().padStart(2,'0')}`);
                    }
                }
                return dts.slice(0, 8);
            };

            return (
                <div>
                    <div className="no-print bg-black text-white p-4 flex justify-between items-center px-10 border-b-4 border-yellow-500">
                        <h1 className="text-xl font-black italic uppercase">Casa da M√∫sica 2026</h1>
                        <button onClick={() => {setAba('menu'); setProfessorAtivo("");}} className="bg-zinc-800 px-4 py-2 font-black text-xs border-2 border-white">VOLTAR AO IN√çCIO</button>
                    </div>

                    {aba === 'menu' ? (
                        <div className="max-w-7xl mx-auto p-10">
                            {!professorAtivo ? (
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                    {professores.map(p => (
                                        <div key={p} onClick={() => setProfessorAtivo(p)} className="card-selecao p-8 text-center font-black uppercase">
                                            <div className="text-4xl mb-2">üë§</div>{p}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div>
                                    <h2 className="text-3xl font-black border-b-8 border-black mb-8 pb-2 uppercase">{professorAtivo}</h2>
                                    <div className="grid grid-cols-2 gap-6">
                                        {turmas.filter(t => t.professor === professorAtivo).map(t => (
                                            <div key={t.id} onClick={() => selecionarTurma(t.id)} className="card-selecao p-6 font-black">
                                                <div className="text-2xl">{t.horario}</div>
                                                <div className="text-sm opacity-60 uppercase">{t.oficina}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="p-4">
                            {carregando ? (
                                <div className="text-center font-black p-20 uppercase">Carregando Di√°rio...</div>
                            ) : (
                                <div className="folha-chamada mx-auto">
                                    <div className="flex justify-between items-start mb-6">
                                        <div className="flex gap-4 items-center">
                                            <div className="w-16 h-16 border-4 border-black flex items-end justify-around p-1">
                                                <div className="w-2 h-10 bg-black"></div><div className="w-2 h-10 bg-black"></div><div className="w-2 h-10 bg-black"></div>
                                            </div>
                                            <div>
                                                <h1 className="text-4xl font-black uppercase leading-none">{turmaAtiva?.professor}</h1>
                                                <p className="text-2xl font-black italic underline uppercase">Oficina: {turmaAtiva?.oficina}</p>
                                            </div>
                                        </div>
                                        <div className="text-right no-print">
                                            <select className="p-2 border-4 border-black font-black uppercase mb-2" value={mes} onChange={e => setMes(Number(e.target.value))}>
                                                {["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"].map((m, i) => <option key={i} value={i}>{m.toUpperCase()}</option>)}
                                            </select>
                                            <button onClick={() => window.print()} className="block bg-black text-white px-6 py-2 font-black uppercase">IMPRIMIR</button>
                                        </div>
                                    </div>

                                    <div className="header-box">
                                        <div className="header-item w-1/3"><label className="text-[10px] block">OFICINA:</label><p className="font-black text-xl uppercase">{turmaAtiva?.oficina}</p></div>
                                        <div className="header-item"><label className="text-[10px] block">M√äS:</label><p className="font-black text-lg uppercase">{["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"][mes]}</p></div>
                                        <div className="header-item"><label className="text-[10px] block">HOR√ÅRIO:</label><p className="font-black text-lg">{turmaAtiva?.horario}</p></div>
                                    </div>

                                    <table className="tabela-chamada">
                                        <thead>
                                            <tr>
                                                <th className="w-12">N¬∫</th>
                                                <th className="w-[350px] text-left px-4">NOME DO ALUNO</th>
                                                {gerarDatas().map(d => <th key={d} className="w-16">{d}</th>)}
                                                {[...Array(Math.max(0, 8 - gerarDatas().length))].map((_, i) => <th key={i} className="w-16"></th>)}
                                                <th className="w-12 bg-zinc-100">P</th><th className="w-12 bg-zinc-100">F</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {alunos.map((a, i) => (
                                                <tr key={i}>
                                                    <td>{i + 1}</td>
                                                    <td className="text-left px-4 uppercase font-black overflow-hidden whitespace-nowrap">{a.nome}</td>
                                                    {[...Array(8)].map((_, di) => <td key={di}></td>)}
                                                    <td className="bg-zinc-100"></td><td className="bg-zinc-100"></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
